<!doctype html>
<html lang="tr">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Poliçe Sorgu">

  <link rel="manifest" href="manifest.json">
<meta charset="utf-t"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Poliçe Sorgu Robotu</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f3f4f6; /* gray-100 */
    --card: #ffffff;
    --muted-text: #1f2937; /* gray-800 */
    --primary-text: #1f2937; /* gray-800 */
    --primary: #1f2937; /* gray-800 */
    --primary-hover: #111827; /* gray-900 */
    --primary-light: #e5e7eb; /* gray-200 */
    --border-color: #d1d5db; /* gray-300 */
    --input-bg: #f3f4f6; /* gray-100 */
    --input-focus-bg: #e5e7eb; /* gray-200 */
    --shadow: 0 1px 2px 0 rgba(60,64,67,0.075), 0 2px 6px 2px rgba(60,64,67,0.0375);
    --radius-m: 20px;
    --radius-l: 20px;
    --success: #34a853;
    --warning: #fbbc05;
  }
  
  html {
    color-scheme: light;
  }

  body{
    margin:0;
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    background: var(--bg);
    color: var(--primary-text);
    min-height: 100vh;
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-size: 14px;
    font-weight: 400;
  }

  #landing-page {
      display: grid;
      place-content: center;
      justify-items: center;
      height: 100vh;
      text-align: center;
      padding: 24px;
      box-sizing: border-box;
      animation: fadeIn 0.5s ease;
  }

  .landing-title {
      font-size: 33px;
      font-weight: 400;
      color: var(--primary-text);
      margin-bottom: 16px;
  }

  .landing-subtitle {
      font-size: 14px;
      color: var(--muted-text);
      max-width: 550px;
      margin-bottom: 40px;
      line-height: 1.6;
  }

  .landing-actions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 350px;
  }

  .landing-button {
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 400;
      border-radius: var(--radius-m);
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
      background-color: var(--card);
      color: var(--primary-text);
  }

  .landing-button:hover:not(:disabled) {
      background-color: var(--input-bg);
  }

  .landing-button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      background-color: var(--input-bg);
      transform: none;
  }

  .landing-button.primary {
      background-color: #1414b8;
      color: #f9fafb;
      border-color: #1414b8;
  }

  .landing-button.primary:hover {
      background-color: #11119f;
  }

  #calculator-page, #excel-page {
      display: none;
  }
  
  .main-wrapper {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 29px;
    box-sizing: border-box;
  }
  
  @media (min-width: 1024px) {
    .main-wrapper {
      display: grid;
      grid-template-columns: 450px 1fr;
      gap: 24px;
      align-items: flex-start;
    }
    .form-column {
      position: -webkit-sticky;
      position: sticky;
      top: 24px;
    }
  }

  .card{
    width: 100%;
    background: var(--card);
    border-radius: var(--radius-l);
    box-shadow: var(--shadow);
    padding: 0;
    box-sizing: border-box;
    overflow: hidden;
  }

  .card-main-content {
    background-color: var(--card);
    padding: 29px;
  }
  
  #goBackBtn, #goBackBtnFromExcel {
    margin-bottom: 16px;
  }

  .header-box {
    margin: -29px -29px 24px -29px;
    padding: 29px;
    background-color: #1414b8;
  }

  h2{
    margin: 0 0 8px;
    font-size: 22px;
    color: var(--primary-text);
    font-weight: 400;
  }
  
  .header-box h2,
  .header-box .sub {
    color: #ffffff;
  }
  
  .sub{
    color: var(--muted-text);
    font-size: 14px;
    margin-bottom: 0;
    line-height: 1.5;
  }
  
  .rate{
    background: var(--input-bg);
    border-radius: var(--radius-m);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 400;
    color: var(--primary-text);
    margin-bottom: 20px;
    font-size: 14px;
    min-height: 48px;
    box-sizing: border-box;
  }

  .rate-text {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .refresh{
    cursor: pointer;
    color: var(--primary);
    font-size: 14px;
    transition: transform .2s ease-in-out;
    border: none;
    background: none;
    padding: 0;
    font-weight: 400;
  }
  
  .refresh:hover{ text-decoration: underline; }
  
  .form-grid{
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .form-section {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .input-group {
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--muted-text);
    font-weight: 400;
  }
  
  input[type=number], input[type=text] {
    width: 100%;
    padding: 11px 14px;
    margin-top: 0;
    border-radius: var(--radius-m);
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    font-size: 14px;
    box-sizing: border-box;
    color: var(--primary-text);
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  input:focus {
    outline: none;
    border-color: var(--border-color);
    background-color: var(--input-focus-bg);
    box-shadow: none;
  }

  .two-col{ display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  
  .input-with-button {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: end;
  }
  .button {
    background-color: var(--card);
    color: var(--primary-text);
    border: 1px solid var(--border-color);
    padding: 11px 20px;
    border-radius: var(--radius-m);
    font-weight: 400;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .button:hover:not(:disabled) {
    background-color: var(--input-bg);
  }
  .button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
  }
  .button.primary {
    background-color: #1414b8;
    color: #f9fafb;
    border-color: #1414b8;
  }
  .button.primary:hover:not(:disabled) {
      background-color: #11119f;
  }
  .button.primary .spinner {
      border-color: #fff;
      border-bottom-color: transparent;
  }

  .results{
    display: none;
    animation: fadeIn 0.5s ease;
    margin-top: 16px;
  }
  
  @media (min-width: 1024px) {
    .results {
      margin-top: 0;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .results-card {
    background: #fff;
    border-radius: var(--radius-l);
    padding: 19px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
  }

  .results-card:last-child {
    margin-bottom: 0;
  }
  
  h3 {
    font-size: 14px;
    font-weight: 400;
    margin: 0 0 12px;
    color: var(--primary-text);
  }
  
  .summary-list {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 0 16px;
  }
  .summary-item {
    display: grid;
    grid-template-columns: subgrid;
    grid-column: 1 / -1;
    font-size: 14px;
    color: var(--primary-text);
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    align-items: baseline;
  }
  .summary-list > .summary-item:last-child {
    padding-bottom: 0;
    border-bottom: none;
  }
  .summary-item > div:first-child { color: var(--muted-text); }
  .summary-item > div:not(:first-child) { 
    font-weight: 400; 
    text-align: right; 
  }
  .summary-item > div:nth-child(2) {
    color: #6b7280; /* gray-500 */
    font-weight: 400;
  }
  
  .summary-item .highlight,
  .summary-item .highlight-label {
    font-weight: 400;
    color: var(--primary-text);
  }

  .results-note{
    margin-top: 16px;
    padding: 12px;
    font-size: 12px;
    color: var(--muted-text);
    background-color: var(--bg);
    border-radius: var(--radius-m);
    line-height: 1.6;
    font-style: italic;
  }
  .results-note strong {
    color: var(--primary-text);
    font-weight: 400;
  }
  
  .note{
    margin-top: 24px;
    font-size: 12px;
    color: var(--muted-text);
    text-align: center;
    background: var(--bg);
    padding: 12px;
    border-radius: var(--radius-m);
    font-style: italic;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  th, td {
    padding: 10px 8px;
    text-align: right;
    border-bottom: 1px solid var(--border-color);
  }
  thead th {
    font-size: 14px;
    font-weight: 400;
    color: var(--muted-text);
    border-bottom-width: 2px;
  }
  tr:last-child td { border-bottom: 0; }
  td:first-child, th:first-child { text-align: left; }
  
  tbody tr { transition: background-color 0.1s ease; }
  tbody tr:hover { background-color: var(--bg); }

  tr.total-row {
    font-weight: 400;
  }
  tr.total-row td {
    color: var(--primary-text);
    font-size: 14px;
  }

  .chart-container {
    height: 313px;
    position: relative;
  }
  
  .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid #fff;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
  }
  
  #rateText .spinner {
     border: 2px solid var(--primary);
     border-bottom-color: transparent;
  }
  
  .button .spinner {
      border-color: var(--primary-text);
      border-bottom-color: transparent;
  }

  @keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .methodology-text {
    font-size: 12px;
    color: var(--muted-text);
    line-height: 1.6;
  }
  .methodology-text p {
    margin-top: 0;
  }
  .methodology-text ul {
    padding-left: 20px;
    margin-top: 0;
    margin-bottom: 0;
    display: grid;
    gap: 8px;
  }
   .methodology-text li::marker {
      color: var(--primary-text);
  }
  .methodology-text strong {
    color: var(--primary-text);
    font-weight: 400;
  }

  .upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-l);
    padding: 20px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    min-height: 150px;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease;
  }
  .upload-area:hover {
      background-color: var(--bg);
  }
  .upload-area.drag-over {
      border-color: #1414b8;
      background-color: #eef2ff; /* indigo-50 */
  }

  @media(max-width: 460px){ 
    .main-wrapper { padding: 19px; }
    .card-main-content { padding: 19px; }
    h2 { font-size: 20px; }
    .sub { font-size: 12.5px; }
    th, td { font-size: 13.2px; padding: 8.8px 4.4px; }
    .header-box {
        margin: -19px -19px 19px -19px;
        padding: 19px;
    }
  }
  
  @media(max-width: 600px) {
    body, .sub, .rate, .refresh, label, input[type=number], input[type=text], .button, h3, .summary-item, .summary-item .highlight, table, thead th, tr.total-row td {
      font-size: 13.2px;
    }
    h2 { font-size: 22px; }
    .results-note, .note { font-size: 12.1px; }
    
    .summary-item {
        padding: 6.6px 0;
    }
    
    .summary-item > div:not(:first-child) {
      white-space: nowrap;
    }
    
    .projection-details-table th, .projection-details-table td {
        padding: 6.6px 3.3px;
        font-size: 13.2px;
        white-space: nowrap;
    }

    .chart-container {
        height: 391px;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/genai-google-web-sdk/v0.12.0/google-genai-web.mjs"
  }
}
</script>
</head>
<body>

  <div id="landing-page">
    <h1 class="landing-title">Hesaplama Araçları</h1>
    <p class="landing-subtitle">Poliçe projeksiyonlarınızı kolayca oluşturun veya görsellerinizdeki verileri anında Excel'e aktarın.</p>
    <div class="landing-actions">
      <button id="goToCalculatorBtn" class="landing-button primary">Poliçe Hesaplama Robotu</button>
      <button id="goToExcelBtn" class="landing-button">Görselden Excel Oluştur</button>
    </div>
  </div>

  <div id="calculator-page">
    <div class="main-wrapper">
      <div class="form-column">
        <button id="goBackBtn" class="landing-button primary">Anasayfaya Geri Dön</button>
        <div class="card" role="region" aria-label="Sigorta Poliçesi Simülatörü">
          <div class="card-main-content">
            <div class="header-box">
              <h2>Poliçe Sorgu Robotu</h2>
              <div class="sub">Brüt maaş ve prim bilgilerinizi girerek 1 yıllık ve 10 yıllık potansiyel vergi iadesi ve birikim projeksiyonunuzu anında hesaplayın.</div>
            </div>

            <div class="rate" id="rateBox">
              <div class="rate-text" id="rateText"></div>
              <button class="refresh" id="refreshBtn" title="Kur yenile">Yenile</button>
            </div>
            
            <form id="calcForm" class="form-grid">
              <div class="form-section">
                <div class="two-col">
                  <div class="input-group">
                    <label for="monthlySalary">Brüt Maaş</label>
                    <input id="monthlySalary" type="text" value="100.000" inputmode="numeric"/>
                  </div>
                  <div class="input-group">
                    <label for="monthlyPremiumUsd">Aylık Prim (USD)</label>
                    <input id="monthlyPremiumUsd" type="text" value="100" inputmode="decimal"/>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="two-col">
                  <div class="input-group">
                    <label for="annualSalaryGrowth">Maaş Artışı (%)</label>
                    <input id="annualSalaryGrowth" type="number" value="15" min="0" step="0.01"/>
                  </div>
                  <div class="input-group">
                    <label for="annualPremiumGrowth">Prim Artışı (%)</label>
                    <input id="annualPremiumGrowth" type="number" value="5" min="0" step="0.01"/>
                  </div>
                </div>
                <div class="two-col">
                  <div class="input-group">
                    <label for="annualUsdGrowth">Kur artışı (%)</label>
                    <input id="annualUsdGrowth" type="number" value="15" min="0" step="0.01"/>
                  </div>
                  <div class="input-group">
                    <label for="usdTry">USD/TRY</label>
                    <input id="usdTry" type="number" step="0.0001" placeholder="Otomatik çekilecek"/>
                  </div>
                </div>
                <div class="two-col" style="grid-template-columns: 1fr 1fr; align-items: end;">
                  <div class="input-group">
                    <label for="annualProfitRate">Kâr Payı (%)</label>
                    <input id="annualProfitRate" type="number" value="6.24" min="0" step="0.01"/>
                  </div>
                  <div class="input-group">
                      <label for="annualExpenseRate">Gider Payı (%)</label>
                      <input id="annualExpenseRate" type="number" value="5" min="0" step="0.01"/>
                  </div>
                  <div class="input-group">
                    <label for="annualTaxBracketGrowth">Vergi Dilimi Artışı (%)</label>
                    <input id="annualTaxBracketGrowth" type="number" value="25" min="0" step="0.01"/>
                  </div>
                  <button type="button" id="resetFormBtn" class="button">Sıfırla</button>
                </div>
              </div>
            </form>

            <div class="note">Kur kaynağı: exchangerate.host. Başarısız olursa fallback (41.95) kullanılır.</div>
          </div>
        </div>
      </div>
      
      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>

  <div id="excel-page">
    <div class="main-wrapper">
      <div class="form-column">
        <button id="goBackBtnFromExcel" class="landing-button primary">Anasayfaya Geri Dön</button>
        <div class="card" role="region" aria-label="Görselden Excel Oluşturucu">
          <div class="card-main-content">
            <div class="header-box">
              <h2>Görselden Excel Oluştur</h2>
              <div class="sub">Yüklediğiniz görseldeki tablo verilerini analiz ederek sizin için bir Excel dosyası oluşturur.</div>
            </div>
            
            <div class="upload-area" id="uploadArea">
              <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp,image/tiff" style="display: none;" />
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="color: var(--border-color);"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
              <p style="font-size: 16px; color: var(--primary-text); margin: 0; font-weight: 400;">Görseli Sürükleyin veya dosya seçin</p>
              <p style="font-size: 12px; color: var(--muted-text); margin: 0;">JPG, PNG, WEBP, TIFF desteklenir</p>
            </div>

            <div id="imagePreview" style="margin-top: 24px; display: none;">
                <p style="margin: 0 0 10px; font-weight: 400; color: var(--muted-text);">Yüklenen Görsel:</p>
                <img id="previewImage" src="" alt="Yüklenen görsel önizlemesi" style="max-width: 100%; border-radius: var(--radius-m); border: 1px solid var(--border-color);"/>
                <button id="generateExcelBtn" class="button primary" style="width: 100%; margin-top: 16px;">
                    Excel Oluştur
                </button>
            </div>
          </div>
        </div>
      </div>
      <div id="excel-results" class="results" aria-live="polite"></div>
    </div>
  </div>

<script type="module">
import { GoogleGenAI, Type } from "@google/genai";

document.addEventListener('DOMContentLoaded', () => {
  // --- Page Navigation ---
  const landingPage = document.getElementById('landing-page');
  const calculatorPage = document.getElementById('calculator-page');
  const excelPage = document.getElementById('excel-page');
  
  const goToCalculatorBtn = document.getElementById('goToCalculatorBtn');
  const goToExcelBtn = document.getElementById('goToExcelBtn');
  
  const goBackBtn = document.getElementById('goBackBtn');
  const goBackBtnFromExcel = document.getElementById('goBackBtnFromExcel');

  function updateView() {
    const hash = window.location.hash;
    
    landingPage.style.display = 'none';
    calculatorPage.style.display = 'none';
    excelPage.style.display = 'none';

    if (hash === '#calculator') {
      calculatorPage.style.display = 'block';
      if (document.getElementById('monthlySalary')) {
        document.getElementById('monthlySalary').value = formatNumber(document.getElementById('monthlySalary').value);
        updateRateAndShow(true);
      }
    } else if (hash === '#excel') {
      excelPage.style.display = 'block';
    } else {
      landingPage.style.display = 'grid';
    }
  }

  goToCalculatorBtn.addEventListener('click', () => { window.location.hash = 'calculator'; });
  goToExcelBtn.addEventListener('click', () => { window.location.hash = 'excel'; });
  goBackBtn.addEventListener('click', () => { window.location.hash = ''; });
  goBackBtnFromExcel.addEventListener('click', () => { window.location.hash = ''; });

  window.addEventListener('hashchange', updateView);
  updateView();
  
  // --- Excel Page Functionality ---
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const imagePreview = document.getElementById('imagePreview');
  const previewImage = document.getElementById('previewImage');
  const generateExcelBtn = document.getElementById('generateExcelBtn');
  const excelResults = document.getElementById('excel-results');
  let latestTableData = [];

  function handleFiles(files) {
    const file = files[0];
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/tiff'];
    
    if (file && allowedTypes.includes(file.type)) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        imagePreview.style.display = 'block';
        excelResults.style.display = 'none'; // Hide previous results
      };
      reader.readAsDataURL(file);
    } else {
      alert('Lütfen geçerli bir resim dosyası seçin (JPG, PNG, WEBP, TIFF).');
      imagePreview.style.display = 'none';
      previewImage.src = '';
      fileInput.value = ''; // Reset file input
    }
  }

  if (uploadArea) {
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        handleFiles(files);
      }
    });
  }

  if (fileInput) {
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFiles(fileInput.files);
      }
    });
  }
  
  if (generateExcelBtn) {
    generateExcelBtn.addEventListener('click', async () => {
        if (!previewImage.src || !fileInput.files[0]) {
            alert("Lütfen önce bir resim dosyası seçin.");
            return;
        }

        generateExcelBtn.disabled = true;
        generateExcelBtn.innerHTML = '<span class="spinner"></span> Oluşturuluyor...';
        excelResults.style.display = 'none';

        try {
            const base64Data = previewImage.src.split(',')[1];
            const mimeType = fileInput.files[0].type;

            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: {
                parts: [
                  { inlineData: { mimeType, data: base64Data } },
                  { text: 'Analyze the table in the provided image. Extract all data, including headers, and return it. Preserve the original order of rows and columns.' }
                ]
              },
              config: {
                 responseMimeType: "application/json",
                 responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                      tableData: {
                        type: Type.ARRAY,
                        description: 'The extracted table data, where each inner array represents a row.',
                        items: {
                          type: Type.ARRAY,
                          items: {
                            type: Type.STRING
                          }
                        }
                      }
                    }
                 },
              },
              systemInstruction: 'You are an expert data entry assistant specializing in accurately extracting tabular data from images.'
            });

            const jsonText = response.text.trim();
            const resultData = JSON.parse(jsonText);
            
            if (resultData.tableData && resultData.tableData.length > 0) {
              renderExcelResults(resultData.tableData);
            } else {
              showError("Görselde okunabilir bir tablo bulunamadı veya veri çıkarılamadı.");
            }

        } catch (error) {
            console.error("API Hatası:", error);
            showError("Veri çıkarılırken bir hata oluştu. Lütfen görseli kontrol edip tekrar deneyin.");
        } finally {
            generateExcelBtn.disabled = false;
            generateExcelBtn.innerHTML = 'Excel Oluştur';
        }
    });
  }

  function renderExcelResults(tableData) {
      latestTableData = tableData;
      const headers = tableData[0] || [];
      const rows = tableData.slice(1);

      const tableHtml = `
          <table class="projection-details-table">
            <thead>
              <tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${rows.map(row => `<tr>${row.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
      `;

      excelResults.innerHTML = `
          <div class="results-card">
            <h3>Çıkarılan Excel Verileri</h3>
            <p class="sub" style="margin-bottom: 16px; color: var(--muted-text);">Bu, görselden çıkarılan verilerin bir önizlemesidir. Aşağıdaki buton ile verileri .xlsx formatında indirebilirsiniz.</p>
            <div style="overflow-x: auto;">${tableHtml}</div>
            <button id="downloadExcelBtn" class="button primary" style="width: 100%; margin-top: 16px;">
                Excel'i İndir (.xlsx)
            </button>
          </div>
      `;
      excelResults.style.display = 'block';
  }

  function showError(message) {
      excelResults.innerHTML = `
          <div class="results-card">
            <h3>Hata</h3>
            <p style="color: var(--muted-text);">${message}</p>
          </div>
      `;
      excelResults.style.display = 'block';
  }

  function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
   }

   function downloadAsXLSX() {
        if (latestTableData.length === 0) {
            alert("İndirilecek veri bulunmuyor.");
            return;
        }
        
        // Create worksheet from array of arrays
        const ws = XLSX.utils.aoa_to_sheet(latestTableData);

        // Create a new workbook
        const wb = XLSX.utils.book_new();

        // Append the worksheet to the workbook
        XLSX.utils.book_append_sheet(wb, ws, "Çıkarılan Veriler");

        // Write the workbook and trigger download
        XLSX.writeFile(wb, "tablo_verileri.xlsx");
    }

   document.body.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'downloadExcelBtn') {
          downloadAsXLSX();
      }
   });


  // --- Calculator Page Functionality ---
  let projectionChartInstances = {};
  Chart.defaults.font.size = 14;
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = '#1f2937';

  const TAX_BRACKETS = [
    { upTo: 158000, rate: 0.15 },
    { upTo: 330000, rate: 0.20 },
    { upTo: 800000, rate: 0.27 },
    { upTo: 4300000, rate: 0.35 },
    { upTo: Infinity, rate: 0.40 }
  ];

  const fmtTL = n => (Math.round(n)).toLocaleString('tr-TR') + ' ₺';
  const fmtUSD = n => (Math.round(n)).toLocaleString('en-US') + ' $';
  const months = ["Oca","Şub","Mar","Nis","May","Haz","Tem","Ağu","Eyl","Eki","Kas","Ara"];

  function formatNumber(value) {
    if (!value) return '';
    const numberString = String(value).replace(/[^\d]/g, '');
    if (numberString === '') return '';
    return new Intl.NumberFormat('tr-TR').format(parseInt(numberString, 10));
  }

  function parseFormattedNumber(value) {
    if (!value) return 0;
    return parseInt(String(value).replace(/[^\d]/g, ''), 10) || 0;
  }

  async function safeFetchUsdTry(){
    const FALLBACK = 41.95;
    try{
      const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=TRY',{cache:"no-store"});
      const j = await res.json();
      const rate = j?.rates?.TRY;
      if(typeof rate === 'number') return { rate, source: 'live' };
      throw new Error();
    }catch{ return { rate: FALLBACK, source: 'fallback' }; }
  }

  function getTaxRateForAnnualIncome(cumulativeIncome, brackets = TAX_BRACKETS){
    for(const b of brackets) if(cumulativeIncome <= b.upTo) return b.rate;
    return brackets[brackets.length-1].rate;
  }
  
  function compute1YearProjection(params) {
    let {
        monthlySalary, monthlyPremiumUsd, usdTry,
        expenseRatePct, profitRatePct
    } = params;
    
    const annualExpenseRate = expenseRatePct / 100;
    const monthlyExpenseRate = annualExpenseRate / 12;
    const annualProfitRate = profitRatePct / 100;
    const monthlyProfitRate = annualProfitRate / 12;

    let fundUsd = 0;
    let totalPremiumTl = 0;
    let totalRebateTl = 0;
    let totalProfitTl = 0;
    let totalExpenseTl = 0;
    let cumulativeIncome = 0;
    let tableRows = "";
    
    let totalProfitUsd = 0;
    let totalExpenseUsd = 0;
    
    for (let i = 0; i < 12; i++) {
        const monthName = months[i];
        
        const profitThisMonthUsd = fundUsd * monthlyProfitRate;
        const expenseThisMonthUsd = fundUsd * monthlyExpenseRate;

        const monthlyPremiumTl = monthlyPremiumUsd * usdTry;

        cumulativeIncome += monthlySalary;
        const taxRate = getTaxRateForAnnualIncome(cumulativeIncome);
        const maxRefundable = monthlySalary * 0.15;
        const actualRefundable = Math.min(monthlyPremiumTl, maxRefundable);
        const rebateTl = actualRefundable * taxRate;
        const rebateUsd = rebateTl / usdTry;
        
        fundUsd += profitThisMonthUsd + monthlyPremiumUsd + rebateUsd - expenseThisMonthUsd;

        totalPremiumTl += monthlyPremiumTl;
        totalRebateTl += rebateTl;
        totalProfitTl += profitThisMonthUsd * usdTry;
        totalExpenseTl += expenseThisMonthUsd * usdTry;
        totalProfitUsd += profitThisMonthUsd;
        totalExpenseUsd += expenseThisMonthUsd;
        
        tableRows += `<tr>
          <td>${monthName}</td> <td>${fmtTL(monthlySalary)}</td>
          <td>${(taxRate*100).toFixed(0)}%</td> <td>${fmtUSD(monthlyPremiumUsd)}</td>
          <td>${fmtUSD(rebateUsd)}</td>
        </tr>`;
    }

    const totalSalary = monthlySalary * 12;
    const totalPremiumUsd = monthlyPremiumUsd * 12;
    const totalRebateUsd = totalRebateTl / usdTry;
    const yearEndTl = fundUsd * usdTry;
    const currentYear = new Date().getFullYear();
    
    tableRows += `<tr class="total-row">
        <td>${currentYear}</td> <td>${fmtTL(totalSalary)}</td> <td>-</td>
        <td>${fmtUSD(totalPremiumUsd)}</td> <td>${fmtUSD(totalRebateUsd)}</td>
      </tr>`;

    return {
        tableRowsHTML: tableRows,
        yearlyTl: totalPremiumTl,
        totalRebateTl: totalRebateTl,
        yearlyProfitTl: totalProfitTl,
        yearlyExpenseTl: totalExpenseTl,
        yearEndTl: yearEndTl,
        yearlyPremiumUsd: totalPremiumUsd,
        totalRebateUsd: totalRebateUsd,
        yearlyProfitUsd: totalProfitUsd,
        yearlyExpenseUsd: totalExpenseUsd,
        yearEndUsd: fundUsd,
    };
}

function compute10YearProjection(params) {
    const years = 10;
    let {
        monthlySalary, monthlyPremiumUsd, usdTryBase,
        expenseRatePct, profitRatePct, premiumGrowthPct,
        salaryGrowthPct, usdGrowthPct, taxBracketGrowthPct
    } = params;

    const annualExpenseRate = expenseRatePct / 100;
    const monthlyExpenseRate = annualExpenseRate / 12;
    const premiumGrowth = premiumGrowthPct / 100;
    const salaryGrowth = salaryGrowthPct / 100;
    const usdGrowth = usdGrowthPct / 100;
    const annualProfitRate = profitRatePct / 100;
    const monthlyProfitRate = annualProfitRate / 12;
    const taxBracketGrowth = taxBracketGrowthPct / 100;

    const yearlyData = [];
    let cumulativePremiumTl = 0;
    let cumulativeRebateTl = 0;
    let cumulativeFundUsd = 0;
    let cumulativeProfitTl = 0;
    let cumulativeExpenseTl = 0;

    let cumulativePremiumUsd = 0;
    let cumulativeRebateUsd = 0;
    let cumulativeProfitUsd = 0;
    let cumulativeExpenseUsd = 0;
    let cumulativePremiumUsdForChart = 0;

    for (let y = 1; y <= years; y++) {
        const yearMonthlySalary = monthlySalary * Math.pow(1 + salaryGrowth, y - 1);
        const yearUsdRate = usdTryBase * Math.pow(1 + usdGrowth, y - 1);
        const yearMonthlyPremiumUsd = monthlyPremiumUsd * Math.pow(1 + premiumGrowth, y - 1);
        
        const adjustedBrackets = TAX_BRACKETS.map(b => ({
          ...b,
          upTo: b.upTo === Infinity ? Infinity : b.upTo * Math.pow(1 + taxBracketGrowth, y - 1)
        }));

        let cumulativeIncomeForYear = 0;
        let rebateAnnualTl = 0;
        let annualPremiumTlForYear = 0;
        let annualProfitTlForYear = 0;
        let annualExpenseTlForYear = 0;

        let rebateAnnualUsd = 0;

        for (let m = 1; m <= 12; m++) {
            const profitThisMonthUsd = cumulativeFundUsd * monthlyProfitRate;
            const expenseThisMonthUsd = cumulativeFundUsd * monthlyExpenseRate;

            const monthlyPremiumTl = yearMonthlyPremiumUsd * yearUsdRate;

            cumulativeIncomeForYear += yearMonthlySalary;
            const taxRateForMonth = getTaxRateForAnnualIncome(cumulativeIncomeForYear, adjustedBrackets);
            const maxRefundablePremiumTlForMonth = yearMonthlySalary * 0.15;
            const actualRefundablePremiumTlForMonth = Math.min(monthlyPremiumTl, maxRefundablePremiumTlForMonth);
            const rebateTlForMonth = actualRefundablePremiumTlForMonth * taxRateForMonth;
            const rebateUsdForMonth = rebateTlForMonth / yearUsdRate;

            cumulativeFundUsd += profitThisMonthUsd + yearMonthlyPremiumUsd + rebateUsdForMonth - expenseThisMonthUsd;

            annualPremiumTlForYear += monthlyPremiumTl;
            rebateAnnualTl += rebateTlForMonth;
            rebateAnnualUsd += rebateUsdForMonth;
            annualProfitTlForYear += profitThisMonthUsd * yearUsdRate;
            annualExpenseTlForYear += expenseThisMonthUsd * yearUsdRate;

            cumulativePremiumUsd += yearMonthlyPremiumUsd;
            cumulativeRebateUsd += rebateUsdForMonth;
            cumulativeProfitUsd += profitThisMonthUsd;
            cumulativeExpenseUsd += expenseThisMonthUsd;
        }
        
        const annualPremiumUsdForYear = yearMonthlyPremiumUsd * 12;
        cumulativePremiumUsdForChart += annualPremiumUsdForYear;

        cumulativePremiumTl += annualPremiumTlForYear;
        cumulativeRebateTl += rebateAnnualTl;
        cumulativeProfitTl += annualProfitTlForYear;
        cumulativeExpenseTl += annualExpenseTlForYear;
        
        const endOfYearFundTl = cumulativeFundUsd * yearUsdRate;

        yearlyData.push({
            year: y,
            annualPremiumTl: annualPremiumTlForYear,
            annualRebateTl: rebateAnnualTl,
            endOfYearFundTl: endOfYearFundTl,
            annualPremiumUsd: annualPremiumUsdForYear,
            annualRebateUsd: rebateAnnualUsd,
            endOfYearFundUsd: cumulativeFundUsd,
            totalPremiumUsd: cumulativePremiumUsdForChart,
            accWithRebateUsd: cumulativeFundUsd,
            totalPremiumTl: cumulativePremiumTl,
            accWithRebateTl: endOfYearFundTl,
        });
    }

    const finalYearUsdRate = usdTryBase * Math.pow(1 + usdGrowth, years - 1);
    const accWithRebateTl = cumulativeFundUsd * finalYearUsdRate;
    const totals = {
        totalPremiumTl: cumulativePremiumTl,
        totalRebateTl: cumulativeRebateTl,
        totalProfitTl: cumulativeProfitTl,
        totalExpenseTl: cumulativeExpenseTl,
        accWithRebateTl: accWithRebateTl,
        totalPremiumUsd: cumulativePremiumUsd,
        totalRebateUsd: cumulativeRebateUsd,
        totalProfitUsd: cumulativeProfitUsd,
        totalExpenseUsd: cumulativeExpenseUsd,
        accWithRebateUsd: cumulativeFundUsd,
    };

    return { totals, yearlyData };
}


  async function updateRateAndShow(autoCompute = false){
    const rt = document.getElementById('rateText');
    if (!rt) return; // Exit if we are not on calculator page
    rt.innerHTML = '<span class="spinner"></span> Kur çekiliyor...';
    const { rate, source } = await safeFetchUsdTry();
    const usdInput = document.getElementById('usdTry');
    if(!usdInput.value) usdInput.value = rate.toFixed(4);
    rt.textContent = `1 USD = ${rate.toFixed(4)} ₺` + (source==='fallback'?' (fallback)':'');
    if(autoCompute) computeAndRender();
  }

  function renderChart(canvasId, data, currency) {
    if (projectionChartInstances[canvasId]) {
      projectionChartInstances[canvasId].destroy();
    }
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const labels = data.map(d => `${d.year}. Yıl`);
    
    let premiumData, gainData, gainLabel, premiumLabel, yTicksFormatter, tooltipFormatter;

    if (currency === 'USD') {
        premiumData = data.map(d => d.totalPremiumUsd);
        gainData = data.map(d => d.accWithRebateUsd);
        gainLabel = 'Toplam Birikim ($)';
        premiumLabel = 'Prim Ödemesi ($)';
        yTicksFormatter = value => {
            if (value >= 1000000) return `${parseFloat((value / 1000000).toFixed(1))}M $`;
            if (value >= 1000) return `${(value / 1000)}K $`;
            return `${value} $`;
        };
        tooltipFormatter = fmtUSD;
    } else { // TL
        premiumData = data.map(d => d.totalPremiumTl);
        gainData = data.map(d => d.accWithRebateTl);
        gainLabel = 'Toplam Birikim (₺)';
        premiumLabel = 'Prim Ödemesi (₺)';
        yTicksFormatter = value => {
            if (value >= 1000000) return `${parseFloat((value / 1000000).toFixed(1))}M ₺`;
            if (value >= 1000) return `${(value / 1000).toLocaleString('tr-TR')}B ₺`;
            return value.toLocaleString('tr-TR') + ' ₺';
        };
        tooltipFormatter = fmtTL;
    }

    projectionChartInstances[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: gainLabel,
          data: gainData,
          borderColor: '#1414b8',
          backgroundColor: 'rgba(20, 20, 184, 0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#1414b8',
          pointRadius: 8
        },{
          label: premiumLabel,
          data: premiumData,
          borderColor: '#9ca3af',
          backgroundColor: 'rgba(156, 163, 175, 0.2)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#9ca3af',
          pointRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              font: {
                size: 12
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: yTicksFormatter,
              font: {
                size: 12
              },
              align: 'start'
            }
          }
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 12,
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            backgroundColor: '#f3f4f6',
            titleColor: '#1f2937',
            bodyColor: '#1f2937',
            titleFont: { family: "'Inter', sans-serif", weight: '400' },
            bodyFont: { family: "'Inter', sans-serif" },
            padding: 12,
            displayColors: false,
            bodySpacing: 4,
            titleMarginBottom: 4,
            callbacks: {
              label: context => context.dataset.label || '',
              afterLabel: context => (context.parsed.y !== null) ? tooltipFormatter(context.parsed.y) : ''
            }
          }
        }
      }
    });
  }
  
  function getParamsFromForm() {
    return {
      monthlySalary: parseFormattedNumber(document.getElementById('monthlySalary').value),
      monthlyPremiumUsd: parseFloat(document.getElementById('monthlyPremiumUsd').value) || 0,
      annualSalaryGrowth: parseFloat(document.getElementById('annualSalaryGrowth').value) || 0,
      annualPremiumGrowth: parseFloat(document.getElementById('annualPremiumGrowth').value) || 0,
      annualUsdGrowth: parseFloat(document.getElementById('annualUsdGrowth').value) || 0,
      usdTry: parseFloat(document.getElementById('usdTry').value) || 0,
      usdTryBase: parseFloat(document.getElementById('usdTry').value) || 0,
      annualProfitRate: parseFloat(document.getElementById('annualProfitRate').value) || 0,
      profitRatePct: parseFloat(document.getElementById('annualProfitRate').value) || 0,
      annualExpenseRate: parseFloat(document.getElementById('annualExpenseRate').value) || 0,
      expenseRatePct: parseFloat(document.getElementById('annualExpenseRate').value) || 0,
      annualTaxBracketGrowth: parseFloat(document.getElementById('annualTaxBracketGrowth').value) || 0,
      premiumGrowthPct: parseFloat(document.getElementById('annualPremiumGrowth').value) || 0,
      salaryGrowthPct: parseFloat(document.getElementById('annualSalaryGrowth').value) || 0,
      usdGrowthPct: parseFloat(document.getElementById('annualUsdGrowth').value) || 0,
      taxBracketGrowthPct: parseFloat(document.getElementById('annualTaxBracketGrowth').value) || 0,
    };
  }
  
  function computeAndRender() {
    const params = getParamsFromForm();
    if (!params.usdTry || !params.monthlySalary || !params.monthlyPremiumUsd) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `<div class="results-card"><p>Lütfen tüm gerekli alanları (maaş, prim, USD kuru) doldurarak tekrar deneyin.</p></div>`;
        resultsDiv.style.display = 'block';
        return;
    }

    const proj1 = compute1YearProjection(params);
    const proj10 = compute10YearProjection(params);

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
      <div class="results-card">
        <h3>
          1 Yıllık Projeksiyon Özeti
        </h3>
        <div class="summary-list">
          <div class="summary-item">
            <div>Yıllık Prim Ödemesi</div><div class="highlight">${fmtTL(proj1.yearlyTl)}</div><div>${fmtUSD(proj1.yearlyPremiumUsd)}</div>
          </div>
          <div class="summary-item">
            <div class="highlight-label">Yıllık Vergi İadesi</div><div class="highlight">${fmtTL(proj1.totalRebateTl)}</div><div>${fmtUSD(proj1.totalRebateUsd)}</div>
          </div>
          <div class="summary-item">
            <div>Yıllık Kâr Payı</div><div class="highlight">${fmtTL(proj1.yearlyProfitTl)}</div><div>${fmtUSD(proj1.yearlyProfitUsd)}</div>
          </div>
          <div class="summary-item">
            <div>Yıllık Gider Payı</div><div class="highlight">${fmtTL(proj1.yearlyExpenseTl)}</div><div>${fmtUSD(proj1.yearlyExpenseUsd)}</div>
          </div>
          <div class="summary-item">
            <div class="highlight-label">Yıl Sonu Birikim</div><div class="highlight">${fmtTL(proj1.yearEndTl)}</div><div>${fmtUSD(proj1.yearEndUsd)}</div>
          </div>
        </div>
      </div>
      <div class="results-card">
        <h3>
          1 Yıllık Detay
        </h3>
        <table class="projection-details-table one-year-table">
            <thead><tr>
                <th>Ay</th><th>Brüt Maaş</th><th>Vergi D.</th><th>Prim</th><th>İade</th>
            </tr></thead>
            <tbody>${proj1.tableRowsHTML}</tbody>
        </table>
      </div>
      <div class="results-card">
        <h3>
          10 Yıllık Projeksiyon Özeti
        </h3>
        <div class="summary-list">
            <div class="summary-item">
              <div>Prim Ödemesi</div><div class="highlight">${fmtTL(proj10.totals.totalPremiumTl)}</div><div>${fmtUSD(proj10.totals.totalPremiumUsd)}</div>
            </div>
            <div class="summary-item">
              <div class="highlight-label">Vergi İadesi</div><div class="highlight">${fmtTL(proj10.totals.totalRebateTl)}</div><div>${fmtUSD(proj10.totals.totalRebateUsd)}</div>
            </div>
            <div class="summary-item">
              <div>Kâr Payı</div><div class="highlight">${fmtTL(proj10.totals.totalProfitTl)}</div><div>${fmtUSD(proj10.totals.totalProfitUsd)}</div>
            </div>
            <div class="summary-item">
              <div>Gider Payı</div><div class="highlight">${fmtTL(proj10.totals.totalExpenseTl)}</div><div>${fmtUSD(proj10.totals.totalExpenseUsd)}</div>
            </div>
            <div class="summary-item">
              <div class="highlight-label">10. Yıl Sonu Birikim</div><div class="highlight">${fmtTL(proj10.totals.accWithRebateTl)}</div><div>${fmtUSD(proj10.totals.accWithRebateUsd)}</div>
            </div>
        </div>
      </div>
       <div class="results-card">
        <h3>
          10 Yıllık Detay
        </h3>
        <table class="projection-details-table ten-year-table">
          <thead><tr>
            <th>Yıl</th><th>Yıllık Prim ($)</th><th>Yıllık İade ($)</th><th>Birikim ($)</th>
          </tr></thead>
          <tbody>
            ${proj10.yearlyData.map(d => `
              <tr>
                <td>${d.year}. Yıl</td>
                <td>${fmtUSD(d.annualPremiumUsd)}</td>
                <td>${fmtUSD(d.annualRebateUsd)}</td>
                <td>${fmtUSD(d.endOfYearFundUsd)}</td>
              </tr>
            `).join('')}
            <tr class="total-row">
              <td>Toplam</td>
              <td>${fmtUSD(proj10.totals.totalPremiumUsd)}</td>
              <td>${fmtUSD(proj10.totals.totalRebateUsd)}</td>
              <td>${fmtUSD(proj10.totals.accWithRebateUsd)}</td>
            </tr>
          </tbody>
        </table>
        <div class="results-note">
            <strong>Not:</strong> 10 yıllık projeksiyon, girdiğiniz yıllık artış varsayımlarına dayanmaktadır. Gerçekleşen değerler farklılık gösterebilir.
        </div>
      </div>
      <div class="results-card">
        <h3>
          10 Yıllık Projeksiyon Grafiği (USD)
        </h3>
        <div class="chart-container"><canvas id="projectionChart"></canvas></div>
      </div>
       <div class="results-card">
        <h3>
          10 Yıllık Projeksiyon Grafiği (TL)
        </h3>
        <div class="chart-container"><canvas id="projectionChartTl"></canvas></div>
      </div>
      <div class="results-card">
        <h3>Hesaplama Metodolojisi</h3>
        <div class="methodology-text">
            <ul>
                <li><strong>Vergi İadesi:</strong> Aylık ödenen primin, brüt maaşın %15'ini aşmayacak kısmı için hesaplanır. İade tutarı, o ay içinde bulunulan gelir vergisi dilimi oranına göre belirlenir.</li>
                <li><strong>Gelir Vergisi Dilimi:</strong> Yıl içindeki kümülatif brüt maaşınıza göre dinamik olarak hesaplanır. Gelecek yıllar için vergi dilimi matrahları, girdiğiniz "Vergi Dilimi Artışı" oranında bileşik olarak artırılır. Örneğin, 2024 yılı için 158.000 TL olan ilk dilim sınırı, %25'lik bir artış varsayımıyla <strong>2025 yılı için 158.000 ₺ * 1.25 = 197.500 ₺</strong> olarak hesaplanır. Bu hesaplama her yıl tüm dilimler için tekrarlanır.</li>
                <li><strong>Birikim Hesabı (USD):</strong> USD cinsinden olan birikim fonunuz, her ay ödediğiniz <strong>USD prim tutarı</strong>, TL olarak hesaplanıp o anki kurdan <strong>USD'ye çevrilen vergi iadesi</strong> ve mevcut birikiminiz üzerinden hesaplanan <strong>kâr payının</strong> eklenmesiyle büyür. Aynı şekilde, mevcut birikiminiz üzerinden hesaplanan <strong>gider payı</strong> bu toplamdan düşülür.</li>
                <li><strong>10 Yıllık Projeksiyon ve Varsayımlar:</strong> Maaş, prim ve vergi dilimleri için girdiğiniz yıllık artış oranları varsayımlarına dayanır. Benzer şekilde, <strong>gelecek yıllardaki USD/TRY kuru</strong> da mevcut kur üzerine girdiğiniz yıllık "Kur Artışı (%)" oranının bileşik olarak eklenmesiyle tahmin edilir. Bu sebeple sonuçlar, gelecekteki piyasa koşullarına göre farklılık gösterebilecek birer tahmindir.</li>
                <li><strong>Anlık Döviz Kuru:</strong> Simülasyonun başlangıç yılı için güncel USD/TRY kuru anlık olarak harici bir servis üzerinden çekilir. Servise ulaşılamaması durumunda sistemde tanımlı bir kur değeri kullanılır.</li>
            </ul>
        </div>
      </div>
    `;
    resultsDiv.style.display = 'block';
    renderChart('projectionChart', proj10.yearlyData, 'USD');
    renderChart('projectionChartTl', proj10.yearlyData, 'TL');
  }

  // --- Event Listeners and Initial Setup for Calculator ---
  
  const form = document.getElementById('calcForm');
  const salaryInput = document.getElementById('monthlySalary');
  const refreshBtn = document.getElementById('refreshBtn');
  const resetFormBtn = document.getElementById('resetFormBtn');
  
  let calculationTimeout;

  if (form) {
    form.addEventListener('input', (e) => {
      if (e.target.id === 'monthlySalary') {
        const value = e.target.value;
        const formatted = formatNumber(value);
        if (value !== formatted) {
          e.target.value = formatted;
        }
      }
      
      clearTimeout(calculationTimeout);
      calculationTimeout = setTimeout(computeAndRender, 300);
    });
  }
  
  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      document.getElementById('usdTry').value = '';
      updateRateAndShow(true);
    });
  }
  
  if (resetFormBtn) {
    resetFormBtn.addEventListener('click', () => {
        const formElements = form.elements;
        formElements.monthlySalary.value = "100.000";
        formElements.monthlyPremiumUsd.value = "100";
        formElements.annualSalaryGrowth.value = "15";
        formElements.annualPremiumGrowth.value = "5";
        formElements.annualUsdGrowth.value = "15";
        formElements.annualProfitRate.value = "6.24";
        formElements.annualExpenseRate.value = "5";
        formElements.annualTaxBracketGrowth.value = "25";
        
        computeAndRender();
    });
  }
  
  // Initial load for calculator page
  if (calculatorPage.style.display !== 'none' && salaryInput) {
    salaryInput.value = formatNumber(salaryInput.value);
    updateRateAndShow(true);
  }
});
</script>
</body>
</html>